import java.io.IOException;
import java.nio.ByteBuffer;
import java.nio.channels.ReadableByteChannel;
import java.nio.channels.WritableByteChannel;

public class StreamUtils {
	
	public static final int EOF = -1;
	
	// 4Kb
	public static final int defaultBufferSize = 1024 << 2;
	
	/**
	 *  从src，至少复制n个字节数据到dest
	 * @param src
	 * @param dest
	 * @param n
	 * @return
	 * @throws IOException
	 */
	public static int copyN (ReadableByteChannel src, WritableByteChannel dest, int n) throws IOException {
		
		if (n < 0) {
			throw new IllegalArgumentException();
		}

		ByteBuffer buffer = ByteBuffer.allocate(Math.min(n, defaultBufferSize));

		int readCount = 0;

		while (readCount < n) {
			
			if ((n - readCount) < buffer.capacity()) {
				buffer.limit(n - readCount);
			}
			
			int count = src.read(buffer);
			if (count == EOF) {
				break;
			}
			
			readCount += count;
			
			buffer.flip();
			
			while (buffer.hasRemaining()) {
				dest.write(buffer);	
			}
			
			buffer.clear();
		}
		
		return readCount;
	}
}
